---
 syscallas.S |   16 ++++++++++++++++
 syscalldb.h |   37 +++++++++++++++++++++++++++++++++++++
 2 files changed, 53 insertions(+)

Index: glibc-2.31/syscallas.S
===================================================================
--- glibc-2.31.orig/syscallas.S
+++ glibc-2.31/syscallas.S
@@ -1,9 +1,25 @@
 .weak syscalldb
 .type syscalldb,@function
 
+#if defined(__i386__) || defined(__x86_64__)
 syscalldb:
 	.cfi_startproc
 	syscall
 	retq
 	.cfi_endproc
 	.size syscalldb,.-syscalldb
+#elif defined(__powerpc64__)
+syscalldb:
+	.cfi_startproc
+	std %r0, -8(%r1)
+	mflr %r0
+	std %r0, 16(%r1)
+	ld %r0, -8(%r1)
+	sc
+	ld %r0, 16(%r1)
+	mtlr %r0
+	blr
+	.cfi_endproc
+	.size syscalldb,.-syscalldb
+
+#endif
Index: glibc-2.31/syscalldb.h
===================================================================
--- glibc-2.31.orig/syscalldb.h
+++ glibc-2.31/syscalldb.h
@@ -1,6 +1,8 @@
 #ifndef _SYSCALLDB_H_
 #define _SYSCALLDB_H_
 
+#if defined(__x86_64__)
+
 #ifdef __ASSEMBLER__
 
 .include "syscalldb_macro.S"
@@ -13,4 +15,39 @@ asm (".include \"syscalldb_macro.S\"");
 
 #endif /* __ASSEMBLER__ */
 
+#endif /* x86_64 */
+
+#if defined(__powerpc64__)
+
+#ifdef __ASSEMBLER__
+/*
+ * SYSCALLDB_R9:
+ * This macro is a replacement for the 'sc' instruction.
+ * As such its register clobbering behavior is like that of a Linux syscall
+ * where the following registers are volatile: r0, r3-r8, cr0
+ * Since we are doing an API call here we may be clobbering the following
+ * registers: r0, r3-r12, lr, ctr, xer, cr0-cr1, cr5-cr7 (+some fp registers)
+ * So we have to store: r9 - r12, lr, ctr, xer, cr1, cr5-cr7
+ *
+ * We do an ABI compliant call to Graphene's syscalldb with r9 holding the
+ * syscall number (rather than r0) and registers r3-r8 holding parameters.
+ * This way we don't need to worry about the runtimer linker clobbering r0.
+ */
+/* FIXME: we may need to store more registers at a SAFE PLACE! */
+# define SYSCALLDB_R9(FRAMESIZE)                 \
+    std 0,-FRAMESIZE(1); /* save syscall nr */   \
+    mflr 0;                                      \
+    std 0,16(1);         /* save lr */           \
+    ld 9,-FRAMESIZE(1);  /* restore syscall nr */\
+    stdu 1,-FRAMESIZE(1);                        \
+    bl syscalldb;                                \
+    nop;                                         \
+    addi 1,1,FRAMESIZE;                          \
+    ld 0,16(1);         /* restore lr */         \
+    mtlr 0;
+
+#endif /* __ASSEMBLER__ */
+
+#endif /* __powerpc64 */
+
 #endif /* _SYSCALLDB_H_ */
